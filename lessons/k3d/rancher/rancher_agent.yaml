---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: proxy-clusterrole-kubeapiserver
rules:
  - apiGroups: [""]
    resources:
      - nodes/metrics
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
    verbs: ["get", "list", "watch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: proxy-role-binding-kubernetes-master
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: proxy-clusterrole-kubeapiserver
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kube-apiserver
---
apiVersion: v1
kind: Namespace
metadata:
  name: cattle-system

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cattle
  namespace: cattle-system

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cattle-admin-binding
  namespace: cattle-system
  labels:
    cattle.io/creator: "norman"
subjects:
  - kind: ServiceAccount
    name: cattle
    namespace: cattle-system
roleRef:
  kind: ClusterRole
  name: cattle-admin
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: v1
kind: Secret
metadata:
  name: cattle-credentials-dfe16b1
  namespace: cattle-system
type: Opaque
data:
  url: "aHR0cHM6Ly8xOTIuMTY4LjEuMTEwLnNzbGlwLmlvOjg0NDM="
  token: "YnJxaDk2Ymo2Zjc4OGRmNjk2N3M5bmpxY3Q5bmQ0dnRobmxsdHo0d3BzZm5tYmpsejZwc3Nk"
  namespace: ""

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cattle-admin
  labels:
    cattle.io/creator: "norman"
rules:
  - apiGroups:
      - "*"
    resources:
      - "*"
    verbs:
      - "*"
  - nonResourceURLs:
      - "*"
    verbs:
      - "*"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cattle-cluster-agent
  namespace: cattle-system
  annotations:
    management.cattle.io/scale-available: "2"
spec:
  selector:
    matchLabels:
      app: cattle-cluster-agent
  template:
    metadata:
      labels:
        app: cattle-cluster-agent
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/controlplane
                    operator: In
                    values:
                      - "true"
              weight: 100
            - preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: In
                    values:
                      - "true"
              weight: 100
            - preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/master
                    operator: In
                    values:
                      - "true"
              weight: 100
            - preference:
                matchExpressions:
                  - key: cattle.io/cluster-agent
                    operator: In
                    values:
                      - "true"
              weight: 1
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: beta.kubernetes.io/os
                    operator: NotIn
                    values:
                      - windows
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - cattle-cluster-agent
                topologyKey: kubernetes.io/hostname
              weight: 100
      serviceAccountName: cattle
      tolerations:
        # No taints or no controlplane nodes found, added defaults
        - effect: NoSchedule
          key: node-role.kubernetes.io/controlplane
          value: "true"
        - effect: NoSchedule
          key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
        - effect: NoSchedule
          key: "node-role.kubernetes.io/master"
          operator: "Exists"
      containers:
        - name: cluster-register
          imagePullPolicy: IfNotPresent
          env:
            - name: CATTLE_IS_RKE
              value: "false"
            - name: CATTLE_SERVER
              value: "https://192.168.1.110.sslip.io:8443"
            - name: CATTLE_CA_CHECKSUM
              value: "2061b2931f987b13032e5421b92a23426c1430b3d2f84876f901854dca544faf"
            - name: CATTLE_CLUSTER
              value: "true"
            - name: CATTLE_K8S_MANAGED
              value: "true"
            - name: CATTLE_CLUSTER_REGISTRY
              value: ""
            - name: CATTLE_SERVER_VERSION
              value: v2.9.2
            - name: CATTLE_INSTALL_UUID
              value: 8d07f27b-81dc-4556-a429-cb8aef35e192
            - name: CATTLE_INGRESS_IP_DOMAIN
              value: sslip.io
            - name: STRICT_VERIFY
              value: "true"
          image: rancher/rancher-agent:v2.9.2
          volumeMounts:
            - name: cattle-credentials
              mountPath: /cattle-credentials
              readOnly: true
      volumes:
        - name: cattle-credentials
          secret:
            secretName: cattle-credentials-dfe16b1
            defaultMode: 320
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1

---
apiVersion: v1
kind: Service
metadata:
  name: cattle-cluster-agent
  namespace: cattle-system
spec:
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
      name: http
    - port: 443
      targetPort: 444
      protocol: TCP
      name: https-internal
  selector:
    app: cattle-cluster-agent
